<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TACADA ONLINE - OFICIAL</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: none; }
  body { background: #050505; color: gold; font-family: 'Segoe UI', Arial, sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
  
  .header { width: 100%; padding: 10px; display: flex; justify-content: space-around; background: linear-gradient(180deg, #1a1a1a 0%, #000 100%); border-bottom: 2px solid #333; }
  .stat-box { text-align: center; }
  .stat-label { font-size: 10px; color: #888; text-transform: uppercase; }
  .stat-value { color: #fff; font-weight: bold; font-size: 18px; display: block; }
  
  #bet-panel { margin: 10px; display: flex; gap: 6px; justify-content: center; }
  .bet-btn, #custom-bet { padding: 10px; background: #111; border: 1px solid #444; color: #aaa; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
  .active-bet { color: #000 !important; border-color: gold !important; background: gold !important; }
  
  #confirm { margin-bottom: 10px; padding: 12px 30px; background: #00c853; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; width: 90%; max-width: 320px; font-size: 16px; }
  
  .finance-area { display: flex; gap: 10px; width: 90%; max-width: 320px; margin-bottom: 15px; }
  .btn-finance { flex: 1; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }
  .btn-dep { background: #ffd700; color: #000; }
  .btn-saq { background: #2979ff; color: #fff; }

  canvas { background: radial-gradient(circle, #0e4422 0%, #052b14 100%); border: 10px solid #3e2723; border-radius: 8px; cursor: crosshair; }

  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
  .modal-content { background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid gold; width: 85%; max-width: 320px; text-align: center; }
  .modal-content input { width: 100%; padding: 12px; margin: 10px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 6px; outline: none; }
</style>
</head>
<body>

<div class="header">
  <div class="stat-box"><span class="stat-label">Saldo</span><span id="saldo" class="stat-value">R$ 0.00</span></div>
  <div class="stat-box"><span class="stat-label">Retorno (3.0x)</span><span id="lucro" class="stat-value" style="color:#0f0">R$ 30.00</span></div>
  <div class="stat-box"><span class="stat-label">Tempo</span><span id="tempo" class="stat-value" style="color:#ff4444">2.50</span></div>
</div>

<div id="bet-panel">
  <button class="bet-btn active-bet" onclick="selectBet(10,this)">R$ 10</button>
  <button class="bet-btn" onclick="selectBet(20,this)">R$ 20</button>
  <button class="bet-btn" onclick="selectBet(50,this)">R$ 50</button>
  <input type="number" id="custom-bet" placeholder="VALOR" oninput="updateCustom(this.value)">
</div>

<button id="confirm" onclick="confirmBet()">Confirmar Aposta</button>

<div class="finance-area">
  <button class="btn-finance btn-dep" onclick="abrirModal('deposito')">游닌 Dep칩sito</button>
  <button class="btn-finance btn-saq" onclick="abrirModal('saque')">游눶 Saque</button>
</div>

<canvas id="game"></canvas>

<div id="modalFinanceiro" class="modal">
  <div class="modal-content">
    <div id="conteudo-modal"></div>
    <button onclick="fecharModal()" style="color:#888; background:none; border:none; margin-top:15px; font-size: 12px;">[ FECHAR ]</button>
  </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// --- ESTADO DO JOGO ---
let usuarioLogado = localStorage.getItem("usuario") || "jogador";
let valorAposta = 10;
let dificuldadeRTP = 0.95; 
let apostaConfirmada = false; // TRAVA DE SEGURAN칂A

let branca = { x: 0, y: 0, r: 8, vx: 0, vy: 0 };
let dourada = { x: 0, y: 0, r: 8, vx: 0, vy: 0 };
let hole = { x: 0, y: 0, r: 12 };
let mouse = { x: 0, y: 0, down: false };

// --- FUN칂칏ES DE INICIALIZA칂츾O ---
function sortearPosicoes() {
    canvas.width = window.innerWidth * 0.94;
    canvas.height = canvas.width * 0.80;
    const m = 20; 
    const cantos = [{x:m,y:m}, {x:canvas.width-m,y:m}, {x:m,y:canvas.height-m}, {x:canvas.width-m,y:canvas.height-m}];
    const sorteio = cantos[Math.floor(Math.random() * 4)];
    hole.x = sorteio.x; hole.y = sorteio.y;

    const cX = canvas.width / 2;
    const cY = canvas.height / 2;
    dourada.x = (hole.x < cX) ? cX + 30 : cX - 30;
    dourada.y = (hole.y < cY) ? cY + 30 : cY - 30;
    branca.x = dourada.x + (hole.x < cX ? 70 : -70);
    branca.y = dourada.y + (hole.y < cY ? 70 : -70);
    branca.vx = 0; branca.vy = 0; dourada.vx = 0; dourada.vy = 0;
}

// --- L칍GICA DE APOSTA E SALDO ---
async function confirmBet() {
    try {
        const res = await fetch('/fazer-aposta', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user: usuarioLogado, valor: valorAposta })
        });
        const data = await res.json();
        
        if (data.success) {
            apostaConfirmada = true;
            dificuldadeRTP = data.rtp || 0.95;
            document.getElementById("saldo").innerText = `R$ ${data.novoSaldo.toFixed(2)}`;
            alert("Aposta Confirmada! Pode jogar.");
        } else {
            alert(data.message || "Saldo Insuficiente!");
        }
    } catch(e) { 
        alert("Erro ao conectar no servidor. Verifique o Render.");
    }
}

// --- RENDERIZA칂츾O ---
function desenhar() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // CA칂APA
    ctx.beginPath(); ctx.arc(hole.x, hole.y, hole.r, 0, Math.PI*2);
    ctx.fillStyle = "#000"; ctx.fill();
    ctx.strokeStyle = "gold"; ctx.lineWidth = 3; ctx.stroke();

    // MIRA PONTILHADA (CORRE칂츾O BUG 2)
    if(mouse.down && apostaConfirmada) {
        ctx.beginPath();
        ctx.setLineDash([5, 5]); // Deixa pontilhado
        ctx.moveTo(branca.x, branca.y);
        // Trajet칩ria inversa (estilingue)
        let dx = branca.x - mouse.x;
        let dy = branca.y - mouse.y;
        ctx.lineTo(branca.x + dx, branca.y + dy);
        ctx.strokeStyle = "rgba(255,215,0,0.8)"; ctx.stroke();
        ctx.setLineDash([]); // Reseta o estilo
    }

    // BOLAS
    ctx.fillStyle = "#fff";
    ctx.beginPath(); ctx.arc(branca.x, branca.y, branca.r, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "gold";
    ctx.beginPath(); ctx.arc(dourada.x, dourada.y, dourada.r, 0, Math.PI*2); ctx.fill();

    moverBolas();
    requestAnimationFrame(desenhar);
}

function moverBolas() {
    [branca, dourada].forEach(b => {
        b.x += b.vx; b.y += b.vy;
        b.vx *= 0.98; b.vy *= 0.98;
        if(b.x < b.r || b.x > canvas.width - b.r) b.vx *= -1;
        if(b.y < b.r || b.y > canvas.height - b.r) b.vy *= -1;
    });

    // COLIS츾O COM RTP (CORRE칂츾O BUG 2)
    let dx = dourada.x - branca.x;
    let dy = dourada.y - branca.y;
    let dist = Math.sqrt(dx*dx + dy*dy);
    if(dist < branca.r + dourada.r) {
        dourada.vx = (branca.vx * dificuldadeRTP);
        dourada.vy = (branca.vy * dificuldadeRTP);
        branca.vx *= -0.4;
    }

    // VIT칍RIA
    let distHole = Math.sqrt(Math.pow(dourada.x-hole.x, 2) + Math.pow(dourada.y-hole.y, 2));
    if(distHole < hole.r) {
        alert("GANHOU!");
        apostaConfirmada = false; // Precisa apostar de novo
        sortearPosicoes();
    }
}

// --- INPUTS (MOUSE + TOUCH) ---
function atualizarMouse(e) {
    const r = canvas.getBoundingClientRect();
    const ev = e.touches ? e.touches[0] : e;
    mouse.x = ev.clientX - r.left;
    mouse.y = ev.clientY - r.top;
}

canvas.addEventListener("mousedown", (e) => { mouse.down = true; atualizarMouse(e); });
canvas.addEventListener("touchstart", (e) => { mouse.down = true; atualizarMouse(e); e.preventDefault(); });
canvas.addEventListener("mousemove", (e) => { atualizarMouse(e); });
canvas.addEventListener("touchmove", (e) => { atualizarMouse(e); e.preventDefault(); });

window.addEventListener("mouseup", disparar);
window.addEventListener("touchend", disparar);

function disparar() {
    if(mouse.down && apostaConfirmada) {
        branca.vx = (branca.x - mouse.x) * 0.12;
        branca.vy = (branca.y - mouse.y) * 0.12;
         apostaConfirmada = false;  Descomente para exigir nova aposta ap칩s cada tacada
    } else if (mouse.down && !apostaConfirmada) {
        alert("Confirme a aposta primeiro!");
    }
    mouse.down = false;
}

sortearPosicoes();
desenhar();
atualizarSaldoVisual();
</script>
</body>
</html>
