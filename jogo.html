let usuarioLogado = localStorage.getItem("usuario") || "jogador";
let valorAposta = 10;
let dificuldadeRTP = 0.95; 

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// Ajuste de tamanho dinâmico
function ajustarTela() {
    canvas.width = window.innerWidth * 0.94;
    canvas.height = canvas.width * 0.80;
}
ajustarTela();

let branca = { x: 0, y: 0, r: 8, vx: 0, vy: 0 };
let dourada = { x: 0, y: 0, r: 8, vx: 0, vy: 0 };
let hole = { x: 0, y: 0, r: 18 };
let arrastando = false;
let mouseX, mouseY;

function sortearPosicoes() {
    const m = 40; // Margem para não colidir com a borda no início
    const cantos = [
        {x: m, y: m}, 
        {x: canvas.width - m, y: m}, 
        {x: m, y: canvas.height - m}, 
        {x: canvas.width - m, y: canvas.height - m}
    ];
    
    // Sorteia a caçapa
    const escolhida = cantos[Math.floor(Math.random() * 4)];
    hole.x = escolhida.x;
    hole.y = escolhida.y;

    const centroX = canvas.width / 2;
    const centroY = canvas.height / 2;

    // Posiciona a dourada oposta à caçapa
    dourada.x = (hole.x < centroX) ? centroX + 30 : centroX - 30;
    dourada.y = (hole.y < centroY) ? centroY + 30 : centroY - 30;
    dourada.vx = 0; dourada.vy = 0;

    // Posiciona a branca atrás da dourada
    branca.x = dourada.x + (hole.x < centroX ? 60 : -60);
    branca.y = dourada.y + (hole.y < centroY ? 60 : -60);
    branca.vx = 0; branca.vy = 0;
}

function desenhar() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 1. DESENHAR CAÇAPA (O BUG ESTAVA AQUI: Agora ela tem borda e sombra isolada)
    ctx.save();
    ctx.beginPath();
    ctx.arc(hole.x, hole.y, hole.r, 0, Math.PI * 2);
    ctx.fillStyle = "#000";
    ctx.shadowBlur = 10;
    ctx.shadowColor = "black";
    ctx.fill();
    ctx.strokeStyle = "gold";
    ctx.lineWidth = 3;
    ctx.stroke();
    ctx.restore();

    // 2. LINHA DE MIRA (APARECE AO ARRASTAR)
    if (arrastando) {
        ctx.beginPath();
        ctx.moveTo(branca.x, branca.y);
        ctx.lineTo(mouseX, mouseY);
        ctx.strokeStyle = "rgba(255,255,255,0.3)";
        ctx.setLineDash([5, 5]);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    // 3. BOLA BRANCA
    ctx.fillStyle = "#fff";
    ctx.beginPath(); ctx.arc(branca.x, branca.y, branca.r, 0, Math.PI*2); ctx.fill();

    // 4. BOLA DOURADA
    ctx.save();
    ctx.shadowBlur = 10; ctx.shadowColor = "gold";
    ctx.fillStyle = "gold";
    ctx.beginPath(); ctx.arc(dourada.x, dourada.y, dourada.r, 0, Math.PI*2); ctx.fill();
    ctx.restore();

    atualizarFisica();
    requestAnimationFrame(desenhar);
}

function atualizarFisica() {
    // Movimento simples com atrito
    [branca, dourada].forEach(b => {
        b.x += b.vx; b.y += b.vy;
        b.vx *= 0.98; b.vy *= 0.98; // Atrito da mesa
        
        // Colisão com bordas
        if(b.x < b.r || b.x > canvas.width - b.r) b.vx *= -1;
        if(b.y < b.r || b.y > canvas.height - b.r) b.vy *= -1;
    });

    // Colisão Branca com Dourada
    let dx = dourada.x - branca.x;
    let dy = dourada.y - branca.y;
    let dist = Math.sqrt(dx*dx + dy*dy);
    if(dist < branca.r + dourada.r) {
        dourada.vx = branca.vx * dificuldadeRTP; // Aplica o RTP na força
        dourada.vy = branca.vy * dificuldadeRTP;
        branca.vx *= -0.5;
    }

    // Verificação de Vitória (Dourada na Caçapa)
    let dHole = Math.sqrt(Math.pow(dourada.x - hole.x, 2) + Math.pow(dourada.y - hole.y, 2));
    if(dHole < hole.r) {
        dourada.x = -100; // Some com a bola
        alert("GANHOU! Tacada certeira!");
        sortearPosicoes();
    }
}

// CONTROLES DE MOUSE / TOUCH
canvas.addEventListener("mousedown", e => { arrastando = true; });
canvas.addEventListener("mousemove", e => {
    const rect = canvas.getBoundingClientRect();
    mouseX = e.clientX - rect.left;
    mouseY = e.clientY - rect.top;
});
window.addEventListener("mouseup", e => {
    if(arrastando) {
        let dx = branca.x - mouseX;
        let dy = branca.y - mouseY;
        branca.vx = dx * 0.15;
        branca.vy = dy * 0.15;
        arrastando = false;
    }
});

// Funções Financeiras (Mantidas conforme seu código)
async function confirmBet() {
    try {
        const rtpRes = await fetch("/admin/get-rtp");
        const rtpData = await rtpRes.json();
        dificuldadeRTP = rtpData.rtp;
    } catch (e) { console.log("Usando RTP padrão"); }
    alert("Aposta de R$ " + valorAposta + " confirmada! Pode dar a tacada.");
}

function selectBet(v, btn) {
    valorAposta = v;
    document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('active-bet'));
    btn.classList.add('active-bet');
    document.getElementById("lucro").innerText = `R$ ${(valorAposta * 3).toFixed(2)}`;
}

// INICIALIZAÇÃO
sortearPosicoes();
desenhar();
