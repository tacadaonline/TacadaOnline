<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TACADA ONLINE</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: none; }
  body { background: #050505; color: gold; font-family: 'Segoe UI', Arial, sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
  
  /* HEADER: FOCO TOTAL NO RETORNO E SALDO */
  .header { width: 100%; padding: 15px; display: flex; justify-content: space-around; background: linear-gradient(180deg, #1a1a1a 0%, #000 100%); border-bottom: 2px solid #333; }
  .stat-box { text-align: center; }
  .stat-label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; display: block; }
  .stat-value { color: #fff; font-weight: bold; font-size: 22px; display: block; }
  
  /* PAINEL DE APOSTA */
  #bet-panel { margin: 15px; display: flex; gap: 8px; align-items: center; justify-content: center; }
  .bet-btn, #custom-bet { padding: 12px 16px; background: #111; border: 1px solid #444; color: #aaa; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.3s; }
  .active-bet { color: #000 !important; border-color: gold !important; background: gold !important; box-shadow: 0 0 10px gold; }
  #custom-bet { width: 85px; color: #fff; text-align: center; outline: none; }
  
  /* BOT√ÉO PRINCIPAL */
  #confirm { margin-bottom: 15px; padding: 14px 45px; background: #00c853; color: #fff; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; font-size: 16px; }
  
  /* MESA DE JOGO */
  canvas { background: radial-gradient(circle, #0e4422 0%, #052b14 100%); border: 12px solid #3e2723; border-radius: 12px; box-shadow: inset 0 0 60px rgba(0,0,0,0.8), 0 15px 40px rgba(0,0,0,0.9); }
  
  /* RODAP√â: BOT√ïES DE DEP√ìSITO E SAQUE */
  .footer-actions { width: 100%; padding: 15px; display: flex; justify-content: center; gap: 15px; margin-top: auto; background: #000; border-top: 1px solid #222; }
  .btn-footer { flex: 1; max-width: 160px; padding: 12px; border: none; border-radius: 8px; font-weight: bold; text-transform: uppercase; cursor: pointer; font-size: 13px; }
  .btn-deposito { background: #28a745; color: white; }
  .btn-saque { background: #2979ff; color: white; }

  /* MODAL */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; }
  .modal-content { background: #151515; padding: 30px; border-radius: 15px; border: 1px solid gold; width: 85%; max-width: 360px; text-align: center; }
  .modal-content h2 { color: gold; margin-bottom: 20px; font-size: 20px; }
  .modal-content input { width: 100%; padding: 14px; margin-bottom: 15px; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; outline: none; }
  .btn-modal-acao { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; background: gold; color: #000; }

  #msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; display: none; font-weight: 900; z-index: 10; text-align: center; text-shadow: 0 0 25px #000; pointer-events: none; }
</style>
</head>
<body>

<div class="header">
  <div class="stat-box"><span class="stat-label">Saldo</span><span id="saldo" class="stat-value">R$ 0.00</span></div>
  <div class="stat-box"><span class="stat-label">Retorno (3.0x)</span><span id="lucro" class="stat-value" style="color:#0f0">R$ 30.00</span></div>
  <div class="stat-box"><span class="stat-label">Tempo</span><span id="tempo" class="stat-value" style="color:#ff4444">2.50</span></div>
</div>

<div id="bet-panel">
  <button class="bet-btn active-bet" onclick="selectBet(10,this)">R$ 10</button>
  <button class="bet-btn" onclick="selectBet(20,this)">R$ 20</button>
  <button class="bet-btn" onclick="selectBet(50,this)">R$ 50</button>
  <button class="bet-btn" onclick="selectBet(100,this)">R$ 100</button>
  <input type="number" id="custom-bet" placeholder="OUTRO" onfocus="selectCustom()" oninput="updateCustom(this.value)">
</div>

<button id="confirm" onclick="confirmBet()">Confirmar Aposta</button>

<canvas id="game"></canvas>
<div id="msg"></div>

<div class="footer-actions">
  <button class="btn-footer btn-deposito" onclick="abrirModal('deposito')">‚ûï DEPOSITAR</button>
  <button class="btn-footer btn-saque" onclick="abrirModal('saque')">üí∏ SACAR PIX</button>
</div>

<!-- MODAL FINANCEIRO -->
<div id="modalFinanceiro" class="modal">
  <div class="modal-content">
    <div id="conteudo-modal"></div>
    <button onclick="fecharModal()" style="background:transparent; color:#888; border:none; cursor:pointer; margin-top:10px;">FECHAR</button>
  </div>
</div>

<script>
/* ===== LOGICA DE CONEX√ÉO & SALDO ===== */
let usuarioLogado = localStorage.getItem("usuario") || "jogador_teste";
let saldo = 0;
let valorAposta = 10;
let state = "BETTING";

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth * 0.94;
canvas.height = canvas.width * 0.75;

let branca = { x: 0, y: 0, r: 9, color: "#fff" };
let dourada = { x: 0, y: 0, r: 9, color: "#ffd700" };
let hole = { x: 0, y: 0, r: 16 };

/* ===== 1. ALEATORIEDADE REFOR√áADA ===== */
function sortearPosicoes() {
    const margem = 50;
    // Cacapa em um dos 4 cantos aleatoriamente
    const cantos = [
        {x: margem, y: margem}, 
        {x: canvas.width - margem, y: margem}, 
        {x: margem, y: canvas.height - margem}, 
        {x: canvas.width - margem, y: canvas.height - margem}
    ];
    const indexCanto = Math.floor(Math.random() * 4);
    hole.x = cantos[indexCanto].x; hole.y = cantos[indexCanto].y;

    // Bolas em posi√ß√µes 100% aleat√≥rias na mesa
    branca.x = margem + Math.random() * (canvas.width - margem * 2);
    branca.y = margem + Math.random() * (canvas.height - margem * 2);
    
    // Garante que a dourada n√£o nas√ßa em cima da branca
    do {
      dourada.x = margem + Math.random() * (canvas.width - margem * 2);
      dourada.y = margem + Math.random() * (canvas.height - margem * 2);
    } while (Math.hypot(branca.x - dourada.x, branca.y - dourada.y) < 60);

    desenharCena();
}

function desenharCena() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // Cacapa
    ctx.fillStyle = "#000";
    ctx.beginPath(); ctx.arc(hole.x, hole.y, hole.r, 0, Math.PI*2); ctx.fill();
    // Branca
    ctx.fillStyle = branca.color;
    ctx.beginPath(); ctx.arc(branca.x, branca.y, branca.r, 0, Math.PI*2); ctx.fill();
    // Dourada
    ctx.fillStyle = dourada.color;
    ctx.beginPath(); ctx.arc(dourada.x, dourada.y, dourada.r, 0, Math.PI*2); ctx.fill();
}

/* ===== 2. ATUALIZA√á√ÉO DO RETORNO (LUCRO) ===== */
function atualizarLucro() {
    const lucroEl = document.getElementById("lucro");
    if (lucroEl) {
        const total = (valorAposta * 3).toFixed(2);
        lucroEl.innerText = `R$ ${total}`;
    }
}

function selectBet(v, btn) {
    if (state !== "BETTING") return;
    valorAposta = v;
    document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('active-bet'));
    document.getElementById("custom-bet").classList.remove('active-bet');
    btn.classList.add('active-bet');
    atualizarLucro();
}

function selectCustom() {
    document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('active-bet'));
    document.getElementById("custom-bet").classList.add('active-bet');
}

function updateCustom(val) {
    valorAposta = parseFloat(val) || 0;
    atualizarLucro();
}

/* ===== 3. MODAIS SUITPAY NO RODAP√â ===== */
function abrirModal(tipo) {
    const modal = document.getElementById("modalFinanceiro");
    const cont = document.getElementById("conteudo-modal");
    modal.style.display = "flex";

    if (tipo === 'deposito') {
        cont.innerHTML = `
            <h2>DEPOSITAR VIA PIX</h2>
            <input type="number" id="valDep" placeholder="VALOR R$ (EX: 20.00)">
            <button class="btn-modal-acao" onclick="gerarPixSuitpay()">GERAR QR CODE</button>
            <div id="areaPix" style="margin-top:15px"></div>
        `;
    } else {
        cont.innerHTML = `
            <h2>SACAR VIA PIX</h2>
            <input type="number" id="valSaq" placeholder="VALOR R$">
            <input type="text" id="chavePixSaq" placeholder="SUA CHAVE PIX">
            <button class="btn-modal-acao" style="background:#2979ff; color:#fff" onclick="fazerSaque()">SOLICITAR SAQUE</button>
        `;
    }
}

async function gerarPixSuitpay() {
    const valor = document.getElementById("valDep").value;
    if(valor < 5) return alert("Valor m√≠nimo R$ 5,00");
    document.getElementById("areaPix").innerHTML = "<p style='color:white'>Gerando Pix...</p>";
    
    try {
        const res = await fetch("/api/gerar-deposito", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: usuarioLogado, valor })
        });
        const data = await res.json();
        if(data.success) {
            document.getElementById("areaPix").innerHTML = `
                <img src="data:image/png;base64,${data.qrCode}" width="180" style="border:5px solid white; border-radius:10px;"><br>
                <button class="btn-modal-acao" style="background:#333; color:gold; margin-top:10px; font-size:11px" onclick="navigator.clipboard.writeText('${data.copyPaste}'); alert('C√≥digo Copiado!')">COPIAR C√ìDIGO PIX</button>
            `;
        }
    } catch(e) { alert("Erro ao conectar com o servidor."); }
}

function fecharModal() { document.getElementById("modalFinanceiro").style.display = "none"; }

/* ===== INICIALIZA√á√ÉO ===== */
window.onload = () => {
    atualizarLucro(); // Garante que o lucro apare√ßa de cara
    sortearPosicoes(); // Garante bolas aleat√≥rias no in√≠cio
    // carregarSaldo(); <- Sua fun√ß√£o original de saldo
};
</script>
</body>
</html>
