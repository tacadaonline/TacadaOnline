<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TACADA ONLINE</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: none; }
  body { background: #050505; color: gold; font-family: 'Segoe UI', Arial, sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
  .header { width: 100%; padding: 12px; display: flex; justify-content: space-around; background: linear-gradient(180deg, #1a1a1a 0%, #000 100%); border-bottom: 2px solid #333; }
  .stat-box { text-align: center; }
  .stat-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
  .stat-value { color: #fff; font-weight: bold; font-size: 18px; display: block; }
  
  /* BOTÕES DE FINANÇAS */
  .finance-btns { display: flex; gap: 8px; align-items: center; }
  .btn-action { padding: 8px 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 11px; }
  .btn-dep { background: #00c853; color: #fff; }
  .btn-saq { background: #2979ff; color: #fff; }

  #bet-panel { margin: 12px; display: flex; gap: 6px; align-items: center; justify-content: center; }
  .bet-btn, #custom-bet { padding: 10px 14px; background: #222; border: 1px solid #444; color: #aaa; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
  .active-bet { color: #000 !important; border-color: gold !important; background: gold !important; }
  #custom-bet { width: 75px; color: #fff; text-align: center; outline: none; }
  #confirm { margin-bottom: 12px; padding: 12px 35px; background: #00c853; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
  canvas { background: radial-gradient(circle, #0e4422 0%, #052b14 100%); border: 12px solid #3e2723; border-radius: 10px; box-shadow: inset 0 0 60px rgba(0,0,0,0.8), 0 10px 30px rgba(0,0,0,0.9); }
  #msg { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; display: none; font-weight: 900; z-index: 10; text-align: center; text-shadow: 0 0 20px #000; pointer-events: none; }

  /* ESTILO DO MODAL */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; }
  .modal-content { background: #1a1a1a; padding: 25px; border-radius: 12px; border: 1px solid gold; width: 90%; max-width: 350px; text-align: center; }
  .modal-content h2 { margin-bottom: 15px; font-size: 18px; }
  .modal-content input { width: 100%; padding: 12px; margin-bottom: 15px; background: #000; border: 1px solid #333; color: #fff; border-radius: 6px; }
  .btn-modal { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
</style>
</head>
<body>

<div class="header">
  <div class="stat-box"><span class="stat-label">Saldo</span><span id="saldo" class="stat-value">R$ 0.00</span></div>
  <div class="finance-btns">
    <button class="btn-action btn-dep" onclick="abrirModal('deposito')">Depósito</button>
    <button class="btn-action btn-saq" onclick="abrirModal('saque')">Saque</button>
  </div>
  <div class="stat-box"><span class="stat-label">Tempo</span><span id="tempo" class="stat-value" style="color:#ff4444">2.50</span></div>
</div>

<div id="bet-panel">
  <button class="bet-btn active-bet" onclick="selectBet(10,this)">R$ 10</button>
  <button class="bet-btn" onclick="selectBet(20,this)">R$ 20</button>
  <button class="bet-btn" onclick="selectBet(50,this)">R$ 50</button>
  <button class="bet-btn" onclick="selectBet(100,this)">R$ 100</button>
  <input type="number" id="custom-bet" placeholder="VALOR" onfocus="selectCustom()" oninput="updateCustom(this.value)">
</div>

<button id="confirm" onclick="confirmBet()">Confirmar Aposta</button>

<canvas id="game"></canvas>
<div id="msg"></div>

<!-- MODAL PARA DEPÓSITO E SAQUE -->
<div id="modalFinanceiro" class="modal">
  <div class="modal-content">
    <div id="conteudo-modal"></div>
    <button class="btn-modal" style="background:#444; color:#fff" onclick="fecharModal()">FECHAR</button>
  </div>
</div>

<script>
/* ===== LOGICA DE CONEXÃO & SALDO ===== */
let usuarioLogado = localStorage.getItem("usuario");
let saldo = 0;

async function carregarSaldo() {
    if (!usuarioLogado) { window.location.href = "/"; return; }
    try {
        const response = await fetch("/login", { // Reutiliza login para pegar saldo real do banco
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: usuarioLogado, password: "SESSÃO_ATIVA" }) 
        });
        const data = await response.json();
        saldo = data.saldo || 0;
        document.getElementById("saldo").innerText = `R$ ${saldo.toFixed(2)}`;
    } catch(e) {
        saldo = parseFloat(localStorage.getItem("saldo")) || 0;
        document.getElementById("saldo").innerText = `R$ ${saldo.toFixed(2)}`;
    }
}

async function atualizarSaldoNoBanco(valorMudanca) {
    try {
        const response = await fetch("/update-saldo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: usuarioLogado, valor: valorMudanca })
        });
        const data = await response.json();
        if (data.success) {
            saldo = data.novoSaldo;
            document.getElementById("saldo").innerText = `R$ ${saldo.toFixed(2)}`;
            localStorage.setItem("saldo", saldo);
        }
    } catch (err) { console.error("Erro ao atualizar saldo"); }
}

/* ===== CONFIGS DO JOGO ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth * 0.94;
canvas.height = canvas.width * 0.75;

const msgEl = document.getElementById("msg");
let state = "BETTING"; 
let branca = { x: 0, y: 0, vx: 0, vy: 0, r: 8, color: "#fff" };
let dourada = { x: 0, y: 0, vx: 0, vy: 0, r: 8, color: "#ffd700" };
let hole = { x: 0, y: 0, r: 15 };

// ALEATORIEDADE TOTAL DAS BOLAS
function sortearPosicoes() {
    const margem = 40;
    // Buraco (Cacapa) aleatória nos cantos
    const cantos = [
        {x: margem, y: margem}, 
        {x: canvas.width - margem, y: margem}, 
        {x: margem, y: canvas.height - margem}, 
        {x: canvas.width - margem, y: canvas.height - margem}
    ];
    const indexCanto = Math.floor(Math.random() * 4);
    hole.x = cantos[indexCanto].x; hole.y = cantos[indexCanto].y;

    // Bolas em posições aleatórias (longe do buraco)
    branca.x = margem + Math.random() * (canvas.width - margem * 2);
    branca.y = margem + Math.random() * (canvas.height - margem * 2);
    
    dourada.x = margem + Math.random() * (canvas.width - margem * 2);
    dourada.y = margem + Math.random() * (canvas.height - margem * 2);

    branca.vx = 0; branca.vy = 0; dourada.vx = 0; dourada.vy = 0;
}

/* ===== FUNÇÕES DE MODAL (SUITPAY) ===== */
function abrirModal(tipo) {
    const modal = document.getElementById("modalFinanceiro");
    const cont = document.getElementById("conteudo-modal");
    modal.style.display = "flex";

    if (tipo === 'deposito') {
        cont.innerHTML = `
            <h2>DEPOSITAR VIA PIX</h2>
            <input type="number" id="valDep" placeholder="VALOR R$ (Mín. 10)">
            <button class="btn-modal" style="background:gold; color:#000" onclick="gerarPix()">GERAR QR CODE</button>
            <div id="pixOutput" style="margin-top:10px"></div>
        `;
    } else {
        cont.innerHTML = `
            <h2>SACAR SALDO</h2>
            <input type="number" id="valSaq" placeholder="VALOR DO SAQUE">
            <input type="text" id="chavePix" placeholder="SUA CHAVE PIX">
            <button class="btn-modal" style="background:#2979ff; color:#fff" onclick="realizarSaque()">SOLICITAR PIX</button>
        `;
    }
}

function fecharModal() { document.getElementById("modalFinanceiro").style.display = "none"; }

async function gerarPix() {
    const valor = document.getElementById("valDep").value;
    if(valor < 10) return alert("Mínimo R$ 10,00");
    
    document.getElementById("pixOutput").innerHTML = "<p>Processando...</p>";
    
    try {
        const res = await fetch("/api/gerar-deposito", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: usuarioLogado, valor: valor })
        });
        const data = await res.json();
        if(data.success) {
            document.getElementById("pixOutput").innerHTML = `
                <img src="data:image/png;base64,${data.qrCode}" width="150"><br>
                <button class="btn-modal" style="background:#333; color:gold; font-size:10px" onclick="navigator.clipboard.writeText('${data.copyPaste}'); alert('Copiado!')">COPIAR CÓDIGO PIX</button>
            `;
        }
    } catch(e) { alert("Erro ao conectar com Suitpay"); }
}

async function realizarSaque() {
    const valor = document.getElementById("valSaq").value;
    const chave = document.getElementById("chavePix").value;
    if(valor > saldo) return alert("Saldo insuficiente");

    const res = await fetch("/api/solicitar-saque", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: usuarioLogado, valor, chavePix: chave })
    });
    const data = await res.json();
    alert(data.msg);
    fecharModal();
    carregarSaldo();
}

// Inicia o jogo
window.onload = () => {
    carregarSaldo();
    sortearPosicoes();
    // Inicie aqui seu loop de renderização (ctx.draw...)
};

/* Restante das suas funções selectBet, confirmBet, etc (Mantenha as originais aqui embaixo) */
</script>
</body>
</html>
