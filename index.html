/* ===== SETUP ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth * 0.94;
canvas.height = canvas.width * 0.8;

const saldoEl = document.getElementById("saldo");
const betEl = document.getElementById("bet");
const tempoEl = document.getElementById("tempo");
const msgEl = document.getElementById("msg");

let saldo = 1000;
let betValue = 10;
let lockedBet = 0;
let state = "BETTING"; 
let time = 3;
let timerIniciado = false;

/* ===== BALLS ===== */
function ball(x, y, c) {
  return { x, y, vx: 0, vy: 0, r: 9, color: c };
}
let branca = ball(canvas.width * 0.85, canvas.height * 0.8, "#fff");
let dourada = ball(canvas.width / 2, canvas.height / 2, "#ffd700");
const hole = { x: 30, y: 30, r: 18 };

/* ===== CONTROLE DE TOQUE (FORÇA E MIRA) ===== */
let start = { x: 0, y: 0 }, power = 0, angle = 0, charging = false;

canvas.addEventListener("touchstart", e => {
  if (state !== "PLAYING") return;
  const touch = e.touches[0];
  start = { x: touch.clientX, y: touch.clientY };
  charging = true;
  timerIniciado = true; // O tempo começa no primeiro toque
});

canvas.addEventListener("touchmove", e => {
  if (!charging) return;
  const touch = e.touches[0];
  let dx = start.x - touch.clientX;
  let dy = start.y - touch.clientY;
  
  angle = Math.atan2(dy, dx);
  // Força controlada pelo tamanho do arraste
  power = Math.min(Math.hypot(dx, dy) / 1.5, 100);
});

canvas.addEventListener("touchend", () => {
  if (!charging) return;
  charging = false;
  // Dispara com a força acumulada no arraste
  branca.vx = Math.cos(angle) * (power / 6);
  branca.vy = Math.sin(angle) * (power / 6);
});

/* ===== LÓGICA DE APOSTA ===== */
function selectBet(v, btn) {
  if (state !== "BETTING") return;
  betValue = v;
  betEl.innerText = `R$ ${v.toFixed(2)}`;
  document.querySelectorAll(".bet-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
}

function confirmBet() {
  if (state !== "BETTING") return;
  if (saldo < betValue) { show("SALDO INSUFICIENTE", "#ff4444"); return; }
  
  lockedBet = betValue;
  saldo -= lockedBet;
  saldoEl.innerText = `R$ ${saldo.toFixed(2)}`;
  
  state = "PLAYING";
  document.getElementById("confirm").style.opacity = "0.5";
  document.getElementById("confirm").innerText = "MIRA E JOGA!";
  show("BOA SORTE!", "gold");
}

/* ===== LOOP DE FÍSICA ===== */
function update() {
  if (state === "PLAYING" && timerIniciado) {
    time -= 1/60;
    tempoEl.innerText = Math.max(0, time).toFixed(2);
    if (time <= 0) finish(false, "TEMPO ESGOTADO");
  }

  // Movimentação das bolas
  [branca, dourada].forEach(b => {
    b.x += b.vx; b.y += b.vy;
    b.vx *= 0.985; b.vy *= 0.985;
    if (Math.abs(b.vx) < 0.1) b.vx = 0;
    if (Math.abs(b.vy) < 0.1) b.vy = 0;
    if (b.x - b.r < 0 || b.x + b.r > canvas.width) b.vx *= -0.8;
    if (b.y - b.r < 0 || b.y + b.r > canvas.height) b.vy *= -0.8;
  });

  // Colisão entre bolas
  let dx = dourada.x - branca.x;
  let dy = dourada.y - branca.y;
  if (Math.hypot(dx, dy) < branca.r + dourada.r) {
    let a = Math.atan2(dy, dx);
    let v = Math.hypot(branca.vx, branca.vy);
    dourada.vx = Math.cos(a) * v * 0.9;
    dourada.vy = Math.sin(a) * v * 0.9;
    branca.vx *= -0.3; branca.vy *= -0.3;
  }

  // Condição de Vitória/Derrota
  if (Math.hypot(dourada.x - hole.x, dourada.y - hole.y) < hole.r) {
    finish(true);
  }
  if (state === "PLAYING" && timerIniciado && !charging && branca.vx === 0 && dourada.vx === 0) {
    finish(false, "ERROU");
  }
}

/* ===== DESENHO ===== */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Caçapa
  ctx.fillStyle = "#000";
  ctx.beginPath(); ctx.arc(hole.x, hole.y, hole.r, 0, Math.PI * 2); ctx.fill();
  
  // MIRA PONTILHADA
  if (charging && state === "PLAYING") {
    ctx.beginPath();
    ctx.setLineDash([5, 5]); // Linha pontilhada
    ctx.moveTo(branca.x, branca.y);
    ctx.lineTo(branca.x + Math.cos(angle) * (power * 1.5), branca.y + Math.sin(angle) * (power * 1.5));
    ctx.strokeStyle = "rgba(255, 255, 255, 0.4)";
    ctx.stroke();
    ctx.setLineDash([]); // Reseta para linha sólida
  }

  [branca, dourada].forEach(b => {
    ctx.fillStyle = b.color;
    ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2); ctx.fill();
  });
}

function finish(win, msg) {
  if (state !== "PLAYING") return;
  state = "RESULT";
  if (win) {
    let gain = lockedBet * 2;
    saldo += gain;
    show(`GANHOU R$ ${gain.toFixed(2)}`, "gold");
  } else {
    show(msg || "PERDEU", "#ff4444");
  }
  saldoEl.innerText = `R$ ${saldo.toFixed(2)}`;
  setTimeout(reset, 1500);
}

function reset() {
  branca = ball(canvas.width * 0.85, canvas.height * 0.8, "#fff");
  dourada = ball(canvas.width / 2, canvas.height / 2, "#ffd700");
  time = 3;
  tempoEl.innerText = "3.00";
  timerIniciado = false;
  state = "BETTING";
  document.getElementById("confirm").style.opacity = "1";
  document.getElementById("confirm").innerText = "CONFIRMAR APOSTA";
}

function show(t, c) {
  msgEl.innerText = t; msgEl.style.color = c; msgEl.style.display = "block";
  setTimeout(() => msgEl.style.display = "none", 1500);
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
    
